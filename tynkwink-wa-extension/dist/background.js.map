{
  "version": 3,
  "sources": ["../src/common/storage.ts", "../src/background.ts"],
  "sourcesContent": ["import type { AuthState } from \"./types\";\n\nconst KEY = \"tynkwink_auth_v1\";\n\nexport async function saveAuth(auth: AuthState) {\n  await chrome.storage.local.set({ [KEY]: auth });\n}\n\nexport async function getAuth(): Promise<AuthState> {\n  const res = await chrome.storage.local.get([KEY]);\n  const auth = res[KEY] as AuthState | undefined;\n\n  return {\n    apiBase: auth?.apiBase ?? null,\n    token: auth?.token ?? null,\n    tenantId: auth?.tenantId ?? null\n  };\n}\n", "import type { BgMessage } from \"./common/types\";\nimport { getAuth, saveAuth } from \"./common/storage\";\n\nconst DEFAULT_API_BASE = \"https://api.tynkwink.com\";\n\nchrome.runtime.onMessage.addListener((message: BgMessage, _sender, sendResponse) => {\n  (async () => {\n    try {\n      if (message.type === \"AUTH_SAVE\") {\n        // Basic normalization\n        const apiBase = (message.auth.apiBase ?? \"\").trim().replace(/\\/+$/, \"\");\n        const token = (message.auth.token ?? \"\").trim();\n        const tenantId = (message.auth.tenantId ?? \"\").trim();\n\n        await saveAuth({\n          apiBase: apiBase || null,\n          token: token || null,\n          tenantId: tenantId || null\n        });\n\n        sendResponse({ ok: true });\n        return;\n      }\n\n      if (message.type === \"AUTH_GET\") {\n        const auth = await getAuth();\n        sendResponse({ ok: true, auth });\n        return;\n      }\n\n      if (message.type === \"AUTH_LOGIN\") {\n        const auth = await getAuth();\n        const apiBase = auth.apiBase || DEFAULT_API_BASE;\n        const url = `${apiBase}/api/auth/login`;\n\n        const resp = await fetch(url, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            email: message.payload.email,\n            password: message.payload.password,\n            tenantId: message.payload.tenantId || undefined\n          })\n        });\n\n        const data = await resp.json().catch(() => ({}));\n        if (!resp.ok) {\n          sendResponse({ ok: false, error: data?.message || \"Login failed\" });\n          return;\n        }\n\n        if (data?.requiresTenantSelection) {\n          sendResponse({\n            ok: true,\n            requiresTenantSelection: true,\n            tenants: data?.tenants ?? []\n          });\n          return;\n        }\n\n        await saveAuth({\n          apiBase,\n          token: data?.accessToken || null,\n          tenantId: data?.tenantId || null\n        });\n\n        sendResponse({\n          ok: true,\n          auth: {\n            apiBase,\n            token: data?.accessToken || null,\n            tenantId: data?.tenantId || null\n          }\n        });\n        return;\n      }\n\n      if (message.type === \"SYNC_CHAT\") {\n        const auth = await getAuth();\n        if (!auth.apiBase || !auth.token || !auth.tenantId) {\n          sendResponse({ ok: false, error: \"Not authenticated. Log in to Tynkwink CRM from the WhatsApp overlay.\" });\n          return;\n        }\n\n        // CHANGE HERE: Your backend route path\n        const url = `${auth.apiBase}/api/integrations/whatsapp-web/sync`;\n\n        const resp = await fetch(url, {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            \"Authorization\": `Bearer ${auth.token}`\n          },\n          body: JSON.stringify({\n            tenantId: auth.tenantId, // backend should override/verify against token claims\n            ...message.payload\n          })\n        });\n\n        const data = await resp.json().catch(() => ({}));\n        if (!resp.ok) {\n          sendResponse({\n            ok: false,\n            error: data?.message || \"Sync failed\",\n            status: resp.status,\n            data\n          });\n          return;\n        }\n\n        sendResponse({ ok: true, data });\n        return;\n      }\n\n      sendResponse({ ok: false, error: \"Unknown message type\" });\n    } catch (e: any) {\n      sendResponse({ ok: false, error: e?.message || \"Unexpected error\" });\n    }\n  })();\n\n  // Required for async response\n  return true;\n});\n"],
  "mappings": "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",
  "names": []
}
