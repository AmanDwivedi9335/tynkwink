{
  "version": 3,
  "sources": ["../src/common/storage.ts", "../src/background.ts"],
  "sourcesContent": ["import type { AuthState } from \"./types\";\n\nconst KEY = \"tynkwink_auth_v1\";\n\nexport async function saveAuth(auth: AuthState) {\n  await chrome.storage.local.set({ [KEY]: auth });\n}\n\nexport async function getAuth(): Promise<AuthState> {\n  const res = await chrome.storage.local.get([KEY]);\n  const auth = res[KEY] as AuthState | undefined;\n\n  return {\n    apiBase: auth?.apiBase ?? null,\n    token: auth?.token ?? null,\n    tenantId: auth?.tenantId ?? null\n  };\n}\n", "import type { BgMessage } from \"./common/types\";\nimport { getAuth, saveAuth } from \"./common/storage\";\n\nconst DEFAULT_API_BASE = \"http://localhost:4000\";\nconst API_PREFIX = \"/api\";\nconst LOGIN_TIMEOUT_MS = 12000;\nconst SYNC_TIMEOUT_MS = 20000;\nconst RETRY_STATUSES = new Set([429, 502, 503, 504]);\n\nfunction buildApiUrl(apiBase: string, path: string) {\n  const trimmed = apiBase.replace(/\\/+$/, \"\");\n  if (trimmed.endsWith(API_PREFIX)) {\n    return `${trimmed}${path}`;\n  }\n  return `${trimmed}${API_PREFIX}${path}`;\n}\n\nfunction isLocalhost(hostname: string) {\n  return hostname === \"localhost\" || hostname === \"127.0.0.1\";\n}\n\nfunction normalizeApiBase(raw: string | null) {\n  if (!raw) return { apiBase: null, error: null };\n  try {\n    const url = new URL(raw);\n    if (url.search || url.hash) {\n      return { apiBase: null, error: \"API Base URL must not include query parameters or fragments.\" };\n    }\n    if (url.protocol !== \"https:\" && !(url.protocol === \"http:\" && isLocalhost(url.hostname))) {\n      return { apiBase: null, error: \"API Base URL must use https (http allowed only for localhost).\" };\n    }\n    const pathname = url.pathname.replace(/\\/+$/, \"\");\n    const normalized = `${url.origin}${pathname ? pathname : \"\"}`;\n    return { apiBase: normalized, error: null };\n  } catch {\n    return { apiBase: null, error: \"API Base URL is not a valid URL.\" };\n  }\n}\n\nasync function fetchWithTimeout(url: string, options: RequestInit, timeoutMs: number) {\n  const controller = new AbortController();\n  const id = setTimeout(() => controller.abort(), timeoutMs);\n  try {\n    return await fetch(url, { ...options, signal: controller.signal });\n  } finally {\n    clearTimeout(id);\n  }\n}\n\nasync function readResponseBody(resp: Response) {\n  const contentType = resp.headers.get(\"content-type\") || \"\";\n  if (contentType.includes(\"application/json\")) {\n    return resp.json().catch(() => ({}));\n  }\n  const text = await resp.text().catch(() => \"\");\n  return text ? { message: text } : {};\n}\n\nasync function fetchWithRetry(url: string, options: RequestInit, timeoutMs: number, retries = 0) {\n  let attempt = 0;\n  while (true) {\n    attempt += 1;\n    const resp = await fetchWithTimeout(url, options, timeoutMs);\n    if (!RETRY_STATUSES.has(resp.status) || attempt > retries) {\n      return resp;\n    }\n    await new Promise((resolve) => setTimeout(resolve, 300 * attempt));\n  }\n}\n\nchrome.runtime.onMessage.addListener((message: BgMessage, _sender, sendResponse) => {\n  (async () => {\n    try {\n      if (message.type === \"AUTH_SAVE\") {\n        // Basic normalization\n        const apiBaseRaw = (message.auth.apiBase ?? \"\").trim();\n        const { apiBase, error } = normalizeApiBase(apiBaseRaw || null);\n        if (error) {\n          sendResponse({ ok: false, error });\n          return;\n        }\n        const token = (message.auth.token ?? \"\").trim();\n        const tenantId = (message.auth.tenantId ?? \"\").trim();\n\n        await saveAuth({\n          apiBase: apiBase || null,\n          token: token || null,\n          tenantId: tenantId || null\n        });\n\n        sendResponse({ ok: true });\n        return;\n      }\n\n      if (message.type === \"AUTH_GET\") {\n        const auth = await getAuth();\n        sendResponse({ ok: true, auth });\n        return;\n      }\n\n      if (message.type === \"AUTH_LOGIN\") {\n        const auth = await getAuth();\n        const apiBaseInput = auth.apiBase || DEFAULT_API_BASE;\n        const { apiBase, error } = normalizeApiBase(apiBaseInput);\n        if (!apiBase || error) {\n          sendResponse({\n            ok: false,\n            error: error || \"API Base URL is required. Set it from the extension popup.\"\n          });\n          return;\n        }\n        if (!message.payload.email || !message.payload.password) {\n          sendResponse({ ok: false, error: \"Email and password are required.\" });\n          return;\n        }\n        const url = buildApiUrl(apiBase, \"/auth/login\");\n\n        let resp: Response;\n        try {\n          resp = await fetchWithTimeout(url, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({\n              email: message.payload.email,\n              password: message.payload.password,\n              tenantId: message.payload.tenantId || undefined\n            })\n          }, LOGIN_TIMEOUT_MS);\n        } catch (error: any) {\n          sendResponse({\n            ok: false,\n            error:\n              error?.name === \"AbortError\"\n                ? \"Login request timed out. Please try again.\"\n                : error?.message === \"Failed to fetch\"\n                ? \"Unable to reach Tynkwink CRM. Check your internet connection or API Base URL.\"\n                : error?.message || \"Unable to reach Tynkwink CRM.\"\n          });\n          return;\n        }\n\n        const data = await readResponseBody(resp);\n        if (!resp.ok) {\n          sendResponse({ ok: false, error: data?.message || `Login failed (status ${resp.status}).` });\n          return;\n        }\n\n        if (data?.requiresTenantSelection) {\n          sendResponse({\n            ok: true,\n            requiresTenantSelection: true,\n            tenants: data?.tenants ?? []\n          });\n          return;\n        }\n\n        await saveAuth({\n          apiBase,\n          token: data?.accessToken || null,\n          tenantId: data?.tenantId || null\n        });\n\n        sendResponse({\n          ok: true,\n          auth: {\n            apiBase,\n            token: data?.accessToken || null,\n            tenantId: data?.tenantId || null\n          }\n        });\n        return;\n      }\n\n      if (message.type === \"SYNC_CHAT\") {\n        const auth = await getAuth();\n        if (!auth.apiBase || !auth.token || !auth.tenantId) {\n          sendResponse({ ok: false, error: \"Not authenticated. Log in to Tynkwink CRM from the WhatsApp overlay.\" });\n          return;\n        }\n\n        // CHANGE HERE: Your backend route path\n        const url = buildApiUrl(auth.apiBase, \"/integrations/whatsapp-web/sync\");\n\n        let resp: Response;\n        try {\n          resp = await fetchWithRetry(url, {\n            method: \"POST\",\n            headers: {\n              \"Content-Type\": \"application/json\",\n              \"Authorization\": `Bearer ${auth.token}`\n            },\n            body: JSON.stringify({\n              tenantId: auth.tenantId, // backend should override/verify against token claims\n              ...message.payload\n            })\n          }, SYNC_TIMEOUT_MS, 2);\n        } catch (error: any) {\n          sendResponse({\n            ok: false,\n            error:\n              error?.name === \"AbortError\"\n                ? \"Sync request timed out. Please try again.\"\n                : error?.message || \"Unable to reach Tynkwink CRM.\"\n          });\n          return;\n        }\n\n        const data = await readResponseBody(resp);\n        if (!resp.ok) {\n          if (resp.status === 401 || resp.status === 403) {\n            await saveAuth({ apiBase: auth.apiBase, token: null, tenantId: null });\n          }\n          sendResponse({\n            ok: false,\n            error: data?.message || \"Sync failed\",\n            status: resp.status,\n            data\n          });\n          return;\n        }\n\n        sendResponse({ ok: true, data });\n        return;\n      }\n\n      sendResponse({ ok: false, error: \"Unknown message type\" });\n    } catch (e: any) {\n      sendResponse({ ok: false, error: e?.message || \"Unexpected error\" });\n    }\n  })();\n\n  // Required for async response\n  return true;\n});\n"],
  "mappings": ";AAEA,IAAM,MAAM;AAEZ,eAAsB,SAAS,MAAiB;AAC9C,QAAM,OAAO,QAAQ,MAAM,IAAI,EAAE,CAAC,GAAG,GAAG,KAAK,CAAC;AAChD;AAEA,eAAsB,UAA8B;AAClD,QAAM,MAAM,MAAM,OAAO,QAAQ,MAAM,IAAI,CAAC,GAAG,CAAC;AAChD,QAAM,OAAO,IAAI,GAAG;AAEpB,SAAO;AAAA,IACL,SAAS,MAAM,WAAW;AAAA,IAC1B,OAAO,MAAM,SAAS;AAAA,IACtB,UAAU,MAAM,YAAY;AAAA,EAC9B;AACF;;;ACdA,IAAM,mBAAmB;AACzB,IAAM,aAAa;AACnB,IAAM,mBAAmB;AACzB,IAAM,kBAAkB;AACxB,IAAM,iBAAiB,oBAAI,IAAI,CAAC,KAAK,KAAK,KAAK,GAAG,CAAC;AAEnD,SAAS,YAAY,SAAiB,MAAc;AAClD,QAAM,UAAU,QAAQ,QAAQ,QAAQ,EAAE;AAC1C,MAAI,QAAQ,SAAS,UAAU,GAAG;AAChC,WAAO,GAAG,OAAO,GAAG,IAAI;AAAA,EAC1B;AACA,SAAO,GAAG,OAAO,GAAG,UAAU,GAAG,IAAI;AACvC;AAEA,SAAS,YAAY,UAAkB;AACrC,SAAO,aAAa,eAAe,aAAa;AAClD;AAEA,SAAS,iBAAiB,KAAoB;AAC5C,MAAI,CAAC,IAAK,QAAO,EAAE,SAAS,MAAM,OAAO,KAAK;AAC9C,MAAI;AACF,UAAM,MAAM,IAAI,IAAI,GAAG;AACvB,QAAI,IAAI,UAAU,IAAI,MAAM;AAC1B,aAAO,EAAE,SAAS,MAAM,OAAO,+DAA+D;AAAA,IAChG;AACA,QAAI,IAAI,aAAa,YAAY,EAAE,IAAI,aAAa,WAAW,YAAY,IAAI,QAAQ,IAAI;AACzF,aAAO,EAAE,SAAS,MAAM,OAAO,iEAAiE;AAAA,IAClG;AACA,UAAM,WAAW,IAAI,SAAS,QAAQ,QAAQ,EAAE;AAChD,UAAM,aAAa,GAAG,IAAI,MAAM,GAAG,WAAW,WAAW,EAAE;AAC3D,WAAO,EAAE,SAAS,YAAY,OAAO,KAAK;AAAA,EAC5C,QAAQ;AACN,WAAO,EAAE,SAAS,MAAM,OAAO,mCAAmC;AAAA,EACpE;AACF;AAEA,eAAe,iBAAiB,KAAa,SAAsB,WAAmB;AACpF,QAAM,aAAa,IAAI,gBAAgB;AACvC,QAAM,KAAK,WAAW,MAAM,WAAW,MAAM,GAAG,SAAS;AACzD,MAAI;AACF,WAAO,MAAM,MAAM,KAAK,EAAE,GAAG,SAAS,QAAQ,WAAW,OAAO,CAAC;AAAA,EACnE,UAAE;AACA,iBAAa,EAAE;AAAA,EACjB;AACF;AAEA,eAAe,iBAAiB,MAAgB;AAC9C,QAAM,cAAc,KAAK,QAAQ,IAAI,cAAc,KAAK;AACxD,MAAI,YAAY,SAAS,kBAAkB,GAAG;AAC5C,WAAO,KAAK,KAAK,EAAE,MAAM,OAAO,CAAC,EAAE;AAAA,EACrC;AACA,QAAM,OAAO,MAAM,KAAK,KAAK,EAAE,MAAM,MAAM,EAAE;AAC7C,SAAO,OAAO,EAAE,SAAS,KAAK,IAAI,CAAC;AACrC;AAEA,eAAe,eAAe,KAAa,SAAsB,WAAmB,UAAU,GAAG;AAC/F,MAAI,UAAU;AACd,SAAO,MAAM;AACX,eAAW;AACX,UAAM,OAAO,MAAM,iBAAiB,KAAK,SAAS,SAAS;AAC3D,QAAI,CAAC,eAAe,IAAI,KAAK,MAAM,KAAK,UAAU,SAAS;AACzD,aAAO;AAAA,IACT;AACA,UAAM,IAAI,QAAQ,CAAC,YAAY,WAAW,SAAS,MAAM,OAAO,CAAC;AAAA,EACnE;AACF;AAEA,OAAO,QAAQ,UAAU,YAAY,CAAC,SAAoB,SAAS,iBAAiB;AAClF,GAAC,YAAY;AACX,QAAI;AACF,UAAI,QAAQ,SAAS,aAAa;AAEhC,cAAM,cAAc,QAAQ,KAAK,WAAW,IAAI,KAAK;AACrD,cAAM,EAAE,SAAS,MAAM,IAAI,iBAAiB,cAAc,IAAI;AAC9D,YAAI,OAAO;AACT,uBAAa,EAAE,IAAI,OAAO,MAAM,CAAC;AACjC;AAAA,QACF;AACA,cAAM,SAAS,QAAQ,KAAK,SAAS,IAAI,KAAK;AAC9C,cAAM,YAAY,QAAQ,KAAK,YAAY,IAAI,KAAK;AAEpD,cAAM,SAAS;AAAA,UACb,SAAS,WAAW;AAAA,UACpB,OAAO,SAAS;AAAA,UAChB,UAAU,YAAY;AAAA,QACxB,CAAC;AAED,qBAAa,EAAE,IAAI,KAAK,CAAC;AACzB;AAAA,MACF;AAEA,UAAI,QAAQ,SAAS,YAAY;AAC/B,cAAM,OAAO,MAAM,QAAQ;AAC3B,qBAAa,EAAE,IAAI,MAAM,KAAK,CAAC;AAC/B;AAAA,MACF;AAEA,UAAI,QAAQ,SAAS,cAAc;AACjC,cAAM,OAAO,MAAM,QAAQ;AAC3B,cAAM,eAAe,KAAK,WAAW;AACrC,cAAM,EAAE,SAAS,MAAM,IAAI,iBAAiB,YAAY;AACxD,YAAI,CAAC,WAAW,OAAO;AACrB,uBAAa;AAAA,YACX,IAAI;AAAA,YACJ,OAAO,SAAS;AAAA,UAClB,CAAC;AACD;AAAA,QACF;AACA,YAAI,CAAC,QAAQ,QAAQ,SAAS,CAAC,QAAQ,QAAQ,UAAU;AACvD,uBAAa,EAAE,IAAI,OAAO,OAAO,mCAAmC,CAAC;AACrE;AAAA,QACF;AACA,cAAM,MAAM,YAAY,SAAS,aAAa;AAE9C,YAAI;AACJ,YAAI;AACF,iBAAO,MAAM,iBAAiB,KAAK;AAAA,YACjC,QAAQ;AAAA,YACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,YAC9C,MAAM,KAAK,UAAU;AAAA,cACnB,OAAO,QAAQ,QAAQ;AAAA,cACvB,UAAU,QAAQ,QAAQ;AAAA,cAC1B,UAAU,QAAQ,QAAQ,YAAY;AAAA,YACxC,CAAC;AAAA,UACH,GAAG,gBAAgB;AAAA,QACrB,SAASA,QAAY;AACnB,uBAAa;AAAA,YACX,IAAI;AAAA,YACJ,OACEA,QAAO,SAAS,eACZ,+CACAA,QAAO,YAAY,oBACnB,kFACAA,QAAO,WAAW;AAAA,UAC1B,CAAC;AACD;AAAA,QACF;AAEA,cAAM,OAAO,MAAM,iBAAiB,IAAI;AACxC,YAAI,CAAC,KAAK,IAAI;AACZ,uBAAa,EAAE,IAAI,OAAO,OAAO,MAAM,WAAW,wBAAwB,KAAK,MAAM,KAAK,CAAC;AAC3F;AAAA,QACF;AAEA,YAAI,MAAM,yBAAyB;AACjC,uBAAa;AAAA,YACX,IAAI;AAAA,YACJ,yBAAyB;AAAA,YACzB,SAAS,MAAM,WAAW,CAAC;AAAA,UAC7B,CAAC;AACD;AAAA,QACF;AAEA,cAAM,SAAS;AAAA,UACb;AAAA,UACA,OAAO,MAAM,eAAe;AAAA,UAC5B,UAAU,MAAM,YAAY;AAAA,QAC9B,CAAC;AAED,qBAAa;AAAA,UACX,IAAI;AAAA,UACJ,MAAM;AAAA,YACJ;AAAA,YACA,OAAO,MAAM,eAAe;AAAA,YAC5B,UAAU,MAAM,YAAY;AAAA,UAC9B;AAAA,QACF,CAAC;AACD;AAAA,MACF;AAEA,UAAI,QAAQ,SAAS,aAAa;AAChC,cAAM,OAAO,MAAM,QAAQ;AAC3B,YAAI,CAAC,KAAK,WAAW,CAAC,KAAK,SAAS,CAAC,KAAK,UAAU;AAClD,uBAAa,EAAE,IAAI,OAAO,OAAO,uEAAuE,CAAC;AACzG;AAAA,QACF;AAGA,cAAM,MAAM,YAAY,KAAK,SAAS,iCAAiC;AAEvE,YAAI;AACJ,YAAI;AACF,iBAAO,MAAM,eAAe,KAAK;AAAA,YAC/B,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,gBAAgB;AAAA,cAChB,iBAAiB,UAAU,KAAK,KAAK;AAAA,YACvC;AAAA,YACA,MAAM,KAAK,UAAU;AAAA,cACnB,UAAU,KAAK;AAAA;AAAA,cACf,GAAG,QAAQ;AAAA,YACb,CAAC;AAAA,UACH,GAAG,iBAAiB,CAAC;AAAA,QACvB,SAAS,OAAY;AACnB,uBAAa;AAAA,YACX,IAAI;AAAA,YACJ,OACE,OAAO,SAAS,eACZ,8CACA,OAAO,WAAW;AAAA,UAC1B,CAAC;AACD;AAAA,QACF;AAEA,cAAM,OAAO,MAAM,iBAAiB,IAAI;AACxC,YAAI,CAAC,KAAK,IAAI;AACZ,cAAI,KAAK,WAAW,OAAO,KAAK,WAAW,KAAK;AAC9C,kBAAM,SAAS,EAAE,SAAS,KAAK,SAAS,OAAO,MAAM,UAAU,KAAK,CAAC;AAAA,UACvE;AACA,uBAAa;AAAA,YACX,IAAI;AAAA,YACJ,OAAO,MAAM,WAAW;AAAA,YACxB,QAAQ,KAAK;AAAA,YACb;AAAA,UACF,CAAC;AACD;AAAA,QACF;AAEA,qBAAa,EAAE,IAAI,MAAM,KAAK,CAAC;AAC/B;AAAA,MACF;AAEA,mBAAa,EAAE,IAAI,OAAO,OAAO,uBAAuB,CAAC;AAAA,IAC3D,SAAS,GAAQ;AACf,mBAAa,EAAE,IAAI,OAAO,OAAO,GAAG,WAAW,mBAAmB,CAAC;AAAA,IACrE;AAAA,EACF,GAAG;AAGH,SAAO;AACT,CAAC;",
  "names": ["error"]
}
