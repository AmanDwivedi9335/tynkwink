{
  "version": 3,
  "sources": ["../src/ui/overlay.ts", "../src/content.ts"],
  "sourcesContent": ["type OverlayOpts = {\r\n  onSync: () => Promise<any>;\r\n  onCheckAuth: () => Promise<any>;\r\n};\r\n\r\nfunction el<K extends keyof HTMLElementTagNameMap>(tag: K, attrs: Record<string, string> = {}) {\r\n  const node = document.createElement(tag);\r\n  for (const [k, v] of Object.entries(attrs)) node.setAttribute(k, v);\r\n  return node;\r\n}\r\n\r\nexport function mountOverlay(opts: OverlayOpts) {\r\n  const id = \"tw-wa-overlay-root\";\r\n  if (document.getElementById(id)) return;\r\n\r\n  const root = el(\"div\");\r\n  root.id = id;\r\n  root.style.position = \"fixed\";\r\n  root.style.top = \"90px\";\r\n  root.style.right = \"18px\";\r\n  root.style.width = \"340px\";\r\n  root.style.zIndex = \"999999\";\r\n  root.style.background = \"#fff\";\r\n  root.style.border = \"1px solid rgba(0,0,0,0.12)\";\r\n  root.style.borderRadius = \"14px\";\r\n  root.style.boxShadow = \"0 14px 40px rgba(0,0,0,0.18)\";\r\n  root.style.padding = \"12px\";\r\n  root.style.fontFamily = \"system-ui, -apple-system, Segoe UI, Roboto, Arial\";\r\n\r\n  const header = el(\"div\");\r\n  header.style.display = \"flex\";\r\n  header.style.alignItems = \"center\";\r\n  header.style.justifyContent = \"space-between\";\r\n\r\n  const title = el(\"div\");\r\n  title.textContent = \"Tynkwink CRM\";\r\n  title.style.fontWeight = \"700\";\r\n\r\n  const close = el(\"button\");\r\n  close.textContent = \"\u2715\";\r\n  close.style.border = \"none\";\r\n  close.style.background = \"transparent\";\r\n  close.style.cursor = \"pointer\";\r\n  close.style.fontSize = \"14px\";\r\n\r\n  header.appendChild(title);\r\n  header.appendChild(close);\r\n\r\n  const status = el(\"div\");\r\n  status.style.marginTop = \"8px\";\r\n  status.style.fontSize = \"12px\";\r\n  status.style.color = \"#555\";\r\n  status.textContent = \"Checking authentication...\";\r\n\r\n  const syncBtn = el(\"button\");\r\n  syncBtn.textContent = \"Sync current chat\";\r\n  syncBtn.style.marginTop = \"10px\";\r\n  syncBtn.style.width = \"100%\";\r\n  syncBtn.style.padding = \"10px\";\r\n  syncBtn.style.borderRadius = \"12px\";\r\n  syncBtn.style.border = \"1px solid #111\";\r\n  syncBtn.style.background = \"#fff\";\r\n  syncBtn.style.cursor = \"pointer\";\r\n  syncBtn.style.fontWeight = \"600\";\r\n\r\n  const log = el(\"pre\");\r\n  log.style.marginTop = \"10px\";\r\n  log.style.background = \"#f7f7f7\";\r\n  log.style.padding = \"10px\";\r\n  log.style.borderRadius = \"12px\";\r\n  log.style.maxHeight = \"220px\";\r\n  log.style.overflow = \"auto\";\r\n  log.style.fontSize = \"11px\";\r\n  log.textContent = \"\";\r\n\r\n  const note = el(\"div\");\r\n  note.style.marginTop = \"8px\";\r\n  note.style.fontSize = \"11px\";\r\n  note.style.color = \"#666\";\r\n  note.textContent = \"Tip: If it says 'Not authenticated', open extension popup and set API Base, Tenant ID and Token.\";\r\n\r\n  root.appendChild(header);\r\n  root.appendChild(status);\r\n  root.appendChild(syncBtn);\r\n  root.appendChild(log);\r\n  root.appendChild(note);\r\n\r\n  document.body.appendChild(root);\r\n\r\n  close.onclick = () => root.remove();\r\n\r\n  (async () => {\r\n    const res = await opts.onCheckAuth();\r\n    const token = res?.auth?.token;\r\n    status.textContent = token ? \"Authenticated.\" : \"Not authenticated.\";\r\n  })();\r\n\r\n  syncBtn.onclick = async () => {\r\n    log.textContent = \"Syncing...\";\r\n    try {\r\n      const res = await opts.onSync();\r\n      log.textContent = JSON.stringify(res, null, 2);\r\n    } catch (e: any) {\r\n      log.textContent = `Error: ${e?.message || \"unknown\"}`;\r\n    }\r\n  };\r\n}\r\n", "import { mountOverlay } from \"./ui/overlay\";\r\nimport type { SyncPayload, WhatsAppMessage, Direction } from \"./common/types\";\r\n\r\nconst EXTRACTOR_VERSION = \"dom-v1\";\r\n\r\nfunction sleep(ms: number) {\r\n  return new Promise((r) => setTimeout(r, ms));\r\n}\r\n\r\n/**\r\n * IMPORTANT:\r\n * WhatsApp Web DOM changes frequently. These selectors are heuristic.\r\n * You will likely need to adjust logic here over time.\r\n */\r\nfunction getChatTitle(): string {\r\n  // Strategy:\r\n  // 1) find a header area\r\n  // 2) choose the most prominent text node\r\n  const header = document.querySelector(\"header\");\r\n  if (!header) return \"Unknown\";\r\n\r\n  const candidates = Array.from(header.querySelectorAll(\"span\"))\r\n    .map((s) => (s.textContent || \"\").trim())\r\n    .filter((t) => t.length > 0);\r\n\r\n  // Heuristic: pick the longest among top few\r\n  candidates.sort((a, b) => b.length - a.length);\r\n  return candidates[0] || \"Unknown\";\r\n}\r\n\r\n/**\r\n * Best-effort detection:\r\n * WhatsApp Web may not provide phone numbers in DOM reliably.\r\n * Treat phoneE164 as optional.\r\n */\r\nfunction getPhoneE164BestEffort(): string | null {\r\n  // CHANGE HERE if you find a stable way in your WhatsApp Web version.\r\n  return null;\r\n}\r\n\r\n/**\r\n * Message extraction:\r\n * MVP extracts visible text nodes from message bubbles.\r\n * This is not perfect: it may capture extra UI texts.\r\n */\r\nfunction extractVisibleMessages(limit = 50): WhatsAppMessage[] {\r\n  // Primary region where messages are likely rendered\r\n  const main = document.querySelector(\"main\");\r\n  if (!main) return [];\r\n\r\n  // Try to capture message bubble text spans. WhatsApp often uses spans for text.\r\n  const spans = Array.from(main.querySelectorAll(\"span\"))\r\n    .map((n) => (n.textContent || \"\").trim())\r\n    .filter((t) => t.length > 0);\r\n\r\n  // Basic de-noising: remove very common UI artifacts\r\n  const noise = new Set([\"Search\", \"Type a message\", \"Today\", \"Yesterday\"]);\r\n  const cleaned = spans.filter((t) => !noise.has(t));\r\n\r\n  const recent = cleaned.slice(-limit);\r\n\r\n  // Direction inference is hard with naive DOM.\r\n  // Later you can infer using bubble alignment/classes.\r\n  const direction: Direction = \"unknown\";\r\n\r\n  return recent.map((text) => ({\r\n    text,\r\n    direction,\r\n    ts: null\r\n  }));\r\n}\r\n\r\nasync function buildPayload(): Promise<SyncPayload> {\r\n  const title = getChatTitle();\r\n  const isGroup = false; // CHANGE HERE: implement group detection if needed\r\n  const phoneE164 = getPhoneE164BestEffort();\r\n\r\n  const messages = extractVisibleMessages(50);\r\n\r\n  return {\r\n    contact: {\r\n      displayName: title || null,\r\n      phoneE164\r\n    },\r\n    chat: {\r\n      title: title || \"Unknown\",\r\n      isGroup\r\n    },\r\n    messages,\r\n    meta: {\r\n      pageUrl: location.href,\r\n      capturedAt: new Date().toISOString(),\r\n      extractorVersion: EXTRACTOR_VERSION\r\n    }\r\n  };\r\n}\r\n\r\nasync function syncCurrentChat() {\r\n  const payload = await buildPayload();\r\n  const res = await chrome.runtime.sendMessage({ type: \"SYNC_CHAT\", payload });\r\n  return res;\r\n}\r\n\r\nasync function checkAuth() {\r\n  const res = await chrome.runtime.sendMessage({ type: \"AUTH_GET\" });\r\n  return res;\r\n}\r\n\r\n/**\r\n * WhatsApp Web is SPA; the DOM might not be ready immediately even at document_idle.\r\n * We mount overlay after main/header appear.\r\n */\r\nasync function init() {\r\n  for (let i = 0; i < 30; i++) {\r\n    const header = document.querySelector(\"header\");\r\n    const main = document.querySelector(\"main\");\r\n    if (header && main) break;\r\n    await sleep(500);\r\n  }\r\n\r\n  mountOverlay({\r\n    onSync: syncCurrentChat,\r\n    onCheckAuth: checkAuth\r\n  });\r\n}\r\n\r\ninit();\r\n"],
  "mappings": ";AAKA,SAAS,GAA0C,KAAQ,QAAgC,CAAC,GAAG;AAC7F,QAAM,OAAO,SAAS,cAAc,GAAG;AACvC,aAAW,CAAC,GAAG,CAAC,KAAK,OAAO,QAAQ,KAAK,EAAG,MAAK,aAAa,GAAG,CAAC;AAClE,SAAO;AACT;AAEO,SAAS,aAAa,MAAmB;AAC9C,QAAM,KAAK;AACX,MAAI,SAAS,eAAe,EAAE,EAAG;AAEjC,QAAM,OAAO,GAAG,KAAK;AACrB,OAAK,KAAK;AACV,OAAK,MAAM,WAAW;AACtB,OAAK,MAAM,MAAM;AACjB,OAAK,MAAM,QAAQ;AACnB,OAAK,MAAM,QAAQ;AACnB,OAAK,MAAM,SAAS;AACpB,OAAK,MAAM,aAAa;AACxB,OAAK,MAAM,SAAS;AACpB,OAAK,MAAM,eAAe;AAC1B,OAAK,MAAM,YAAY;AACvB,OAAK,MAAM,UAAU;AACrB,OAAK,MAAM,aAAa;AAExB,QAAM,SAAS,GAAG,KAAK;AACvB,SAAO,MAAM,UAAU;AACvB,SAAO,MAAM,aAAa;AAC1B,SAAO,MAAM,iBAAiB;AAE9B,QAAM,QAAQ,GAAG,KAAK;AACtB,QAAM,cAAc;AACpB,QAAM,MAAM,aAAa;AAEzB,QAAM,QAAQ,GAAG,QAAQ;AACzB,QAAM,cAAc;AACpB,QAAM,MAAM,SAAS;AACrB,QAAM,MAAM,aAAa;AACzB,QAAM,MAAM,SAAS;AACrB,QAAM,MAAM,WAAW;AAEvB,SAAO,YAAY,KAAK;AACxB,SAAO,YAAY,KAAK;AAExB,QAAM,SAAS,GAAG,KAAK;AACvB,SAAO,MAAM,YAAY;AACzB,SAAO,MAAM,WAAW;AACxB,SAAO,MAAM,QAAQ;AACrB,SAAO,cAAc;AAErB,QAAM,UAAU,GAAG,QAAQ;AAC3B,UAAQ,cAAc;AACtB,UAAQ,MAAM,YAAY;AAC1B,UAAQ,MAAM,QAAQ;AACtB,UAAQ,MAAM,UAAU;AACxB,UAAQ,MAAM,eAAe;AAC7B,UAAQ,MAAM,SAAS;AACvB,UAAQ,MAAM,aAAa;AAC3B,UAAQ,MAAM,SAAS;AACvB,UAAQ,MAAM,aAAa;AAE3B,QAAM,MAAM,GAAG,KAAK;AACpB,MAAI,MAAM,YAAY;AACtB,MAAI,MAAM,aAAa;AACvB,MAAI,MAAM,UAAU;AACpB,MAAI,MAAM,eAAe;AACzB,MAAI,MAAM,YAAY;AACtB,MAAI,MAAM,WAAW;AACrB,MAAI,MAAM,WAAW;AACrB,MAAI,cAAc;AAElB,QAAM,OAAO,GAAG,KAAK;AACrB,OAAK,MAAM,YAAY;AACvB,OAAK,MAAM,WAAW;AACtB,OAAK,MAAM,QAAQ;AACnB,OAAK,cAAc;AAEnB,OAAK,YAAY,MAAM;AACvB,OAAK,YAAY,MAAM;AACvB,OAAK,YAAY,OAAO;AACxB,OAAK,YAAY,GAAG;AACpB,OAAK,YAAY,IAAI;AAErB,WAAS,KAAK,YAAY,IAAI;AAE9B,QAAM,UAAU,MAAM,KAAK,OAAO;AAElC,GAAC,YAAY;AACX,UAAM,MAAM,MAAM,KAAK,YAAY;AACnC,UAAM,QAAQ,KAAK,MAAM;AACzB,WAAO,cAAc,QAAQ,mBAAmB;AAAA,EAClD,GAAG;AAEH,UAAQ,UAAU,YAAY;AAC5B,QAAI,cAAc;AAClB,QAAI;AACF,YAAM,MAAM,MAAM,KAAK,OAAO;AAC9B,UAAI,cAAc,KAAK,UAAU,KAAK,MAAM,CAAC;AAAA,IAC/C,SAAS,GAAQ;AACf,UAAI,cAAc,UAAU,GAAG,WAAW,SAAS;AAAA,IACrD;AAAA,EACF;AACF;;;ACvGA,IAAM,oBAAoB;AAE1B,SAAS,MAAM,IAAY;AACzB,SAAO,IAAI,QAAQ,CAAC,MAAM,WAAW,GAAG,EAAE,CAAC;AAC7C;AAOA,SAAS,eAAuB;AAI9B,QAAM,SAAS,SAAS,cAAc,QAAQ;AAC9C,MAAI,CAAC,OAAQ,QAAO;AAEpB,QAAM,aAAa,MAAM,KAAK,OAAO,iBAAiB,MAAM,CAAC,EAC1D,IAAI,CAAC,OAAO,EAAE,eAAe,IAAI,KAAK,CAAC,EACvC,OAAO,CAAC,MAAM,EAAE,SAAS,CAAC;AAG7B,aAAW,KAAK,CAAC,GAAG,MAAM,EAAE,SAAS,EAAE,MAAM;AAC7C,SAAO,WAAW,CAAC,KAAK;AAC1B;AAOA,SAAS,yBAAwC;AAE/C,SAAO;AACT;AAOA,SAAS,uBAAuB,QAAQ,IAAuB;AAE7D,QAAM,OAAO,SAAS,cAAc,MAAM;AAC1C,MAAI,CAAC,KAAM,QAAO,CAAC;AAGnB,QAAM,QAAQ,MAAM,KAAK,KAAK,iBAAiB,MAAM,CAAC,EACnD,IAAI,CAAC,OAAO,EAAE,eAAe,IAAI,KAAK,CAAC,EACvC,OAAO,CAAC,MAAM,EAAE,SAAS,CAAC;AAG7B,QAAM,QAAQ,oBAAI,IAAI,CAAC,UAAU,kBAAkB,SAAS,WAAW,CAAC;AACxE,QAAM,UAAU,MAAM,OAAO,CAAC,MAAM,CAAC,MAAM,IAAI,CAAC,CAAC;AAEjD,QAAM,SAAS,QAAQ,MAAM,CAAC,KAAK;AAInC,QAAM,YAAuB;AAE7B,SAAO,OAAO,IAAI,CAAC,UAAU;AAAA,IAC3B;AAAA,IACA;AAAA,IACA,IAAI;AAAA,EACN,EAAE;AACJ;AAEA,eAAe,eAAqC;AAClD,QAAM,QAAQ,aAAa;AAC3B,QAAM,UAAU;AAChB,QAAM,YAAY,uBAAuB;AAEzC,QAAM,WAAW,uBAAuB,EAAE;AAE1C,SAAO;AAAA,IACL,SAAS;AAAA,MACP,aAAa,SAAS;AAAA,MACtB;AAAA,IACF;AAAA,IACA,MAAM;AAAA,MACJ,OAAO,SAAS;AAAA,MAChB;AAAA,IACF;AAAA,IACA;AAAA,IACA,MAAM;AAAA,MACJ,SAAS,SAAS;AAAA,MAClB,aAAY,oBAAI,KAAK,GAAE,YAAY;AAAA,MACnC,kBAAkB;AAAA,IACpB;AAAA,EACF;AACF;AAEA,eAAe,kBAAkB;AAC/B,QAAM,UAAU,MAAM,aAAa;AACnC,QAAM,MAAM,MAAM,OAAO,QAAQ,YAAY,EAAE,MAAM,aAAa,QAAQ,CAAC;AAC3E,SAAO;AACT;AAEA,eAAe,YAAY;AACzB,QAAM,MAAM,MAAM,OAAO,QAAQ,YAAY,EAAE,MAAM,WAAW,CAAC;AACjE,SAAO;AACT;AAMA,eAAe,OAAO;AACpB,WAAS,IAAI,GAAG,IAAI,IAAI,KAAK;AAC3B,UAAM,SAAS,SAAS,cAAc,QAAQ;AAC9C,UAAM,OAAO,SAAS,cAAc,MAAM;AAC1C,QAAI,UAAU,KAAM;AACpB,UAAM,MAAM,GAAG;AAAA,EACjB;AAEA,eAAa;AAAA,IACX,QAAQ;AAAA,IACR,aAAa;AAAA,EACf,CAAC;AACH;AAEA,KAAK;",
  "names": []
}
